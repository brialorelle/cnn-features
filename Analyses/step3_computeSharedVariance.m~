%% set up
close all
clear all
clc
addpath('HelperCode') % add helper code

%% saving figure info
saveDir='Figures'
if ~exist(saveDir); mkdir(saveDir); end 
saveFigFlag=1;

%% Load neural data
load('Data-BrainData/occipitoTemp_Multivariate11-Apr-2018.mat')
% patterns = 8 subjects x 276 dissimilarities (upper triangle of RDM) x 2 image types (originals, texforms)
origNeuralRDM=double(mean(patterns(:,:,1)',2)); %% 1 = originals, averages across 8 subjects.

% specify distance metric
distanceMetric = 'correlation';
layerList = {'conv1', 'conv2', 'conv3', 'conv4', 'conv5', 'fc6', 'fc7'};

for imageType = {'Originals','Texforms','Silhouettes','PhaseScrambled'}
    clear I
    imageType = char(imageType);
    temp = load(['ImageModel-' imageType '.mat']);
    I = temp.I;
    for i = 1:7
        clear featureMatrix featMatbyCat
        % load data:
        layerName = layerList{i};
        [featureMatrix] = loadLayer('Data-AlexNet', layerName,  I.stimSet);
        
        % compute category rdm
        featMatbyCat = collapseByCateg_ASTexforms(featureMatrix, I, 'fullCondInd');
        cnn_rdm_category.(replaceDash(imageType)){i} = pdist(featMatbyCat, distanceMetric);
    end
end

%% compute orig-CNN fit and shared variance with other feature types in each layer

orig_neural_RDM
for layerInd = 1:7
    % fit original RMD with original cnn features in each layer
    origCnnRDM=cnn_rdm_category.Originals{layerInd}';
    temp= regstats(origNeuralRDM, origCnnRDM);
    [origFit(layerInd)] =   temp.rsquare;
    
    % shared variance between tex
    texCnnRDM=cnn_rdm_category.Texforms{layerInd}';
    SV.(RDM_Y_Name).OrigvTex(layerInd) = computeSharedVariance(origNeuralRDM, origCnnRDM, texCnnRDM);
    
    silCnnRDM=cnn_rdm_category.Silhouettes{layerInd}';
    SV.(RDM_Y_Name).OrigvSilhouette(layerInd) = computeSharedVariance(origNeuralRDM, origCnnRDM, rdm_silhouettes);
    
    %%
    clear RDM_X2 RDM_X1
    RDM_X1=cnn_rdm_category.Originals{layerInd}';
    RDM_X2=cnn_rdm_category.PhaseScrambled{layerInd}';
    SV.(RDM_Y_Name).OrigvPhaseScram(layerInd) = computeSharedVariance(origNeuralRDM, RDM_X1, RDM_X2);
    

en

%%
subfigure(2,3,1)
lb=2; ub=7; % layers to plot
comparisons = {'OrigvTex','OrigvPhaseScram','OrigvSilhouette'}
Colors = {[130 130 130],[1 123 118],[86 200 194]}

for layer=lb:ub
   subplot(1,ub-lb+1,layer-lb+1)
   for c=1:length(comparisons)
       thisComparison = comparisons{c}
       toPlot(c) = SV.origRDM.(thisComparison)(layer);
       toPlotLines(c,layer) = SV.origRDM.(thisComparison)(layer);
       bar(c,toPlot(c),'FaceColor',Colors{c}./255); hold on;
       
       ylim([-0 100])
   end
   makepalettablescatter; set(gca,'XTick',[],'YTickLabel',[]); 
   set(gca,'FontSize',18)
end

%%
layerInd = 7
RDM_X1=cnn_rdm_category.Texforms{layerInd}';
RDM_X2=cnn_rdm_category.Silhouettes{layerInd}';
RDM_X3=cnn_rdm_category.Originals{layerInd}';
RDM_X4=cnn_rdm_category.PhaseScrambled{layerInd}';

[phaseOnly]= regstats(origRDM,[RDM_X4]);

[texOnly]= regstats(origRDM,[RDM_X1]);
[texPlusSil]= regstats(origRDM,[RDM_X1 RDM_X2]);
[texPlusSil]= regstats(origRDM,[RDM_X1 RDM_X2]);

texPlusSil.rsquare

[bothFit]= regstats(origRDM,[RDM_X1, RDM_X4]);
[origorig]= regstats(origRDM,[RDM_X1 RDM_X3]);



clear SV
for RDM_Y_Name = {'origRDM'}
    RDM_Y_Name = char(RDM_Y_Name);
    clear RDM_Y
    RDM_Y = eval(RDM_Y_Name);
        

    for layerInd = 1:7
    RDM_X1=cnn_rdm_category.Originals{layerInd}';
    temp= regstats(RDM_Y, [RDM_X1]);
    [origFit(layerInd)] =   temp.rsquare;
    
    RDM_X1=cnn_rdm_category.Originals{layerInd}';

    
    end
end

% %%% Understand CNN unit tunings
% 
% RDM_Y = cnn_rdm_category.Originals{layerInd}';
% 
% for layerInd = 1:7
%     clear  RDM_X1 RDM_X2 
%     RDM_X1=cnn_rdm_category.Silhouettes{layerInd}';
%     RDM_X2=cnn_rdm_category.Texforms{layerInd}';
%     CNN_SV.TexvSil(layerInd) = computeSharedVariance(RDM_Y, RDM_X1, RDM_X2);
%     CNN_SV.TexvOrig(layerInd) = computeSharedVariance(RDM_Y, RDM_Y, RDM_X2);
%     
% end